// TI calculator simulator
// Ken Shirriff, http://righto.com/ti
// Based on patent US3934233
// Code transcribed by Phil Mainwaring
//
// This file holds the source and object code to be executed.

var sourceCode = [
  "START    ZFA    ALL ; init - clear flags",
  "         ZFB    ALL",
  "         AKA    ALL ; clear A and C",
  "         AKC    ALL",
  "MAINLOOP SLLA   MANT ; Restore mantissa",
  "         AKB    ALL ; clear B",
  "WAITSCAN SYNC",
  "         SCAN",
  "         BINE   WAITSCAN",
  "WAITKEY  WAITNO WAITED",
  "WAITED2  SYNC",
  "         SCAN",
  "         BIE    WAITKEY ; loop if no key",
  "         SYNC",
  "         SRLA   MANT",
  "         BKO    LOWERKEY",
  "         BKO    PLUSKEY",
  "         BKO    MINUSKEY",
  "         BKO    DIVKEY",
  "         BKO    MULTKEY",
  "         BKO    UPPERKEY",
  "         BKO    EKEY",
  "         BKO    ZEROKEY",
  "         EXAB   ALL ; save A in B, A=0",
  "         AKCN   DIGIT1 ; count column into A",
  "         EXAB   ALL ; restore A, B holds count",
  "         BINE   MAINLOOP ; C pressed, not in row KN",
  "ZEROKEY  TFB    EMODE ; B holds key 0-9",
  "         BINE   EDIGIT",
  "         TFB    FLAG6B ; if FLAG6B...",
  "         BIE    LABEL33",
  "         AKA    ALL ; then clear A and FLAG6B",
  "         ZFB    FLAG6B",
  "LABEL33  ACKA   DIGIT ; C holds digit position",
  "BSHIFT   SRLB   ALL ; shift B right C times.",
  "         SAKA   DIGIT1 ; decrement A",
  "         BIE    BSHIFT (no borrow)",
  "         ACKC   DIGIT1 ; increment C",
  "         AABA   MANT ; Append new digit",
  "         BIE    MAINLOOP ; done digit processing",
  "EDIGIT   ZFB    NEWEXP ; clear new exponent flag",
  "         SLLA   EXP ; shift exponent left",
  "         SLLB   ALL ; shift digit left",
  "         AABA   EXP ; append new digit to exponent",
  "         BIE    MAINLOOP ; done",
  "EKEY     SFB    EMODE ; entering exponent mode",
  "         SFB    NEWEXP",
  "         BIE    MAINLOOP ; done",
  "LOWERKEY SFA    LOW ; LOW and UP_LOW set for LOWER key",
  "UPPERKEY SFA    UP_LOW ; UP_LOW set for UPPER key",
  "         BIE    MAINLOOP ; done",
  "MINUSKEY TFA    UP_LOW ; alt-MINUS is COS",
  "         BINE   COSKEY",
  "         TFB    NEWEXP ; - follows E?",
  "         BIE    SETNEG",
  "         AAKA   EXP_S ; if so, set minus digit",
  "         BIE    MAINLOOP",
  "SETNEG   AAKA   MANT_S ; set minus digit",
  "         BIE    PLUSKEY ; clear condition flag?",
  "PLUSKEY  TFA    UP_LOW ; alt-PLUS is SIN",
  "         BINE   SINKEY",
  "ADDSUB   AKC    DIGIT ; Add A and C. clear C flag? sign?",
  "         ACKB   ALL ; copy C to B",
  "         ABAC   EXP ; add exponents into C",
  "         BIE    LABEL65 ; why?",
  "LABEL65  ABAC   EXP_S ; add exponent signs",
  "         SCKC   EXP_S ; subtract 5 from sign",
  "         BIE    LABEL72 ; signs were different",
  "         CAB    EXP ; compare exponents",
  "         BIE    LABEL71 ; same",
  "         EXAB   ALL",
  "LABEL71  SABC   EXP ; difference in exponents",
  "LABEL72  CAK    EXP_S",
  "         BINE   LABEL75",
  "         EXAB   ALL",
  "LABEL75  CAK    MANT1",
  "         BIE    BSHIFT2",
  "         EXAB   ALL",
  "BSHIFT2  SCKC   EXP1 ; shift B by difference in exponents to line up",
  "         BINE   DONE2",
  "         SRLB   MANT",
  "         BIE    BSHIFT2",
  "DONE2    ABAC   MANT_S ; add signs and subtract 5",
  "         SCKC   MANT_S",
  "         BIE    LABEL89 ; signs different",
  "EXLOOP   AABA   MANT ; add mantissas",
  "         BIE    WRAPUP ; branch if no overflow",
  "         EXAB   MANT ; handle overflow",
  "         EXAB   MANT_S",
  "LABEL89  SABA   MANT",
  "         BINE   EXLOOP",
  "         BIE    WRAPUP ; BET",
  "LABEL92  CAB    EXP",
  "         BIE    LABEL95",
  "         EXAB   MASK9",
  "LABEL95  SABA   EXP",
  "         BIE    LABEL114 ; BET - no borrow?",
  "DIVKEY   TFA    UP_LOW ; entry point for DIV",
  "         BINE   TANKEY ; alt-DIV is TAN",
  "         SFA    COS_TAN ; why set COS? Doesn't make sense",
  "LABEL100 SFA    RET1FLAG ; 'subroutine call' flag",
  "         BIE    WRAPUP ; BET",
  "RET1     ZFA    RET1FLAG ; RET1FLAG means return here",
  "         AAKA   EXP_S",
  "         BIE    MULTKEY ; clear cc",
  "MULTKEY  TFA    UP_LOW ; alt-MULT is LOG",
  "         BINE   LOGKEY",
  "         AKC    DIGIT",
  "         ACKB   ALL",
  "         EXAB   MANT",
  "         ABAC   EXP_S",
  "         SCKC   EXP_S",
  "         BIE    LABEL92",
  "         AABA   EXP",
  "LABEL114 AABA   MANT_S",
  "         BIE    LABEL116 ; clear before test",
  "LABEL116 TFA    COS_TAN",
  "LABEL117 AKA    MANT",
  "         BINE   LABEL279 ; branch if COS or TAN",
  "MLTLOOP1 SRLA   MANT ; multiply B * C",
  "MLTLOOP2 CCK    MANTLOW1 ; Add B to A, repeat low digit of C times",
  "         BINE   LABEL125",
  "         SCKC   MANT1",
  "         AABA   MANT",
  "         BIE    MLTLOOP2",
  "LABEL125 SRLC   MANT ; shift C right",
  "         CCK    MANT1",
  "         BIE    MLTLOOP1 ; loop if not done",
  "         TFA    LOW",
  "         BINE   LABEL308 ; Return to LABEL308 if LOW flag set (ANTILOG)",
  "WRAPUP   CAK    MANT1 ; Test if mantissa is < 1",
  "         BINE   START ; if mantissa is 0, reset",
  "MANTSHL  CAK    DIGIT1 ; Loop to left-align mantissa",
  "         BIE    MANTOK ; Branch if mantissa aligned",
  "         SLLA   MANT ; Put mantissa back into place",
  "         CAK    EXP_S ; Check sign",
  "         BIE    MANTNEG ; Branch if negative",
  "         SAKA   EXP1 ; Decrement exponent",
  "         BIE    LABEL141 ; Branch if no borrow",
  "         AKA    EXP_S ; Set exponent sign",
  "         AKA    EXP1 ; Set exponent to 1",
  "LABEL141 SAKA   EXP1 ; Decrement exponent",
  "MANTNEG  AAKA   EXP1 ; Increment exponent",
  "         BIE    WLOOP ; first will clear flag",
  "         BIE    WLOOP ; BET",
  "MANTOK   SRLA   MANT",
  "         CAK    EXP_S ; Test exponent sign",
  "         BINE   EXPPOS",
  "         SAKA   EXP1 ; Decrement exponent",
  "         SAKA   EXP1 ; Decrement exponent",
  "EXPPOS   AAKA   EXP1 ; Increment exponent",
  "         BIE    LABEL152 ; clear condition",
  "LABEL152 TFA    RET1FLAG ; Subroutine return?",
  "         BINE   RET1 ; return to RET1 if RET1FLAG set",
  "         ZFB    ALL ; Clear B",
  "         SFB    FLAG6B ; Set op done flag?",
  "         ZFA    ALL ; Clear A flags",
  "         CAK    EXP1 ; Is exponent zero (< 1)",
  "         BIE    EXPPOS",
  "LABEL159 AAKA   EXP_S ; Flip sign",
  "         BIE    LABEL159 ; Branch if sign was clear before",
  "EXPPOS   AAKC   ALL ; Copy A to C",
  "         BIE    MAINLOOP ; BET",
  "TANKEY   SFA    TAN",
  "COSKEY   SFA    COS_TAN",
  "SINKEY   SAKA   EXP1 ; shift mantissa by exponent",
  "         BINE   DONESHFT",
  "         SRLA   MANT",
  "         BIE    SINKEY",
  "DONESHFT AKA    MASK9 ; ?",
  "         SAKA   MASK9",
  "         AKC    ALL ; clear C",
  "         TFA    LOW",
  "         BIE    LABEL180",
  "         TFA    TAN",
  "         BIE    LABEL179",
  "         AAKC   ALL",
  "         AKB    MASK11",
  "         BIE    TRGLOOP2",
  "LABEL179 AAKA   MANTD1",
  "LABEL180 AKB    MANTD5 ; add 5 to B mantissa",
  "         SRLB   MANT ; and shift",
  "         ACKC   MASK11 ; increment C",
  "TRIGLOOP SAKA   MANTD1 ; main loop: iterate A times",
  "         BINE   TRIGDONE ; branch on borrow - done",
  "TRGLOOP2 SLLC   ALL ;",
  "         SLLC   ALL",
  "         SLLC   ALL",
  "         ACKC   MANTD5 ; round C up",
  "         SCBC   ALL ; C-B -> C",
  "         SRLC   ALL ; shift and add to",
  "         SRLC   ALL",
  "         SRLC   ALL",
  "         SLLB   ALL ; shift B left 3",
  "         SLLB   ALL",
  "         SLLB   ALL",
  "         ACKC   MANTD5 ; round C up",
  "         ABCB   ALL ; B+C -> B",
  "         SCKC   MANTD5 ; restore C",
  "         SRLB   ALL ; shift B right 3",
  "         SRLB   ALL",
  "         SRLB   ALL",
  "         TFA    LOW ; ARC-op?",
  "         BIE    TRIGLOOP ; no: branch",
  "         AAKA   MASK9 ; ARC-op",
  "         TFA    TAN",
  "         BIE    ISSINCOS ; branch if SIN/COS",
  "         CCK    DIGIT1 ; doing TAN, compare C to K",
  "         BINE   TRGLOOP2 ; loop if not done",
  "         BIE    TRIG2 ; BET",
  "ISSINCOS TFA    COS_TAN ; SIN/COS",
  "         BINE   ISCOS ; branch if COS",
  "         CAB    MANT ; must be SIN",
  "         BIE    TRGLOOP2",
  "         BIE    TRIG2",
  "ISCOS    CAK    MANT1 ; COS",
  "         EXAB   MANT ; compare C-A the hard way",
  "         CCB    MANT",
  "         EXAB   MANT",
  "         BIE    TRGLOOP2 ; C==A",
  "TRIG2    SRLA   ALL ; shift A right 5",
  "         SRLA   ALL",
  "         SRLA   ALL",
  "         SRLA   ALL",
  "         SRLA   ALL",
  "         BIE    WRAPUP ; done if A zero",
  "TRIGDONE TFA    TAN",
  "         BIE    LABEL233",
  "         ACKA   ALL ; doing TAN",
  "         ABOC   ALL",
  "         AKB    ALL",
  "         ZFA    UP_LOW",
  "         BIE    LABEL100 ; do division??? what is condition here?",
  "LABEL233 TFA    COS_TAN",
  "         BIE    LABEL236 ; branch for SIN",
  "         ACKB   ALL ; COS: return C, rounded",
  "LABEL236 EXAB   ALL ; SIN: return B",
  "         BIE    WRAPUP ; BET (no overflow)",
  "LOGKEY   TFA    LOW ; low-MULT is antilog",
  "         BIE    LOG",
  "ANTILOG  CAK    EXP1 ; antilog - loop",
  "         BINE   LABEL248",
  "         CAK    EXP_S",
  "         BINE   LABEL247",
  "         SRLA   MANT",
  "         SAKA   EXP1",
  "         BIE    ANTILOG",
  "LABEL247 SLLA   MANT",
  "LABEL248 AKA    EXP",
  "         SLLA   MASK8",
  "         SLLA   MASK8",
  "LOG      AKC    ALL ; This loop computes log(.1)/log(.99) = 229",
  "         ACKC   DIGIT1 ; C = 1000000",
  "LOGLOOP  ACKB   MANT ; Compute log B*.99^C until < .1",
  "         SRLB   MANT",
  "         SRLB   MANT",
  "         SCBC   MANT ; C -= C / 100",
  "         TFB    NEWEXP",
  "         BINE   ALOGLOOP",
  "         ACKC   MASK9A ; Count number of iterations",
  "         CCK    MASK11 ; C vs 100000",
  "         BIE    LOGLOOP ; Loop if >=",
  "         SCBB   MASK9 ; Left over bit from B is .15",
  "         ABCC   MANT",
  "         SCKC   MASK11",
  "         SRLB   ALL ; Shift 229 into B mantissa",
  "         SRLB   ALL",
  "         SRLB   ALL",
  "         SRLB   ALL",
  "         ABCB   MANT ; add .15",
  "         EXAB   MANT ; 229.15 in A, arg in B",
  "         TFA    LOW",
  "         BINE   ANTILOG ; return to ANTILOG every time through if LOW set",
  "         ABOC   ALL ; Copy B (arg) to C",
  "         FFA    TAN ; using this flag for something?",
  "         TFA    TAN",
  "         BINE   LOGLOOP ; back to the loop",
  "         AAKC   MANT",
  "LABEL278 AKA    MANT ; clear A mant, arg exp still in A",
  "LABEL279 AKA    DIGIT4 ; start digit count at 4, iterate until 10",
  "LOGDIV   CCB    MANT ; Compute C/B: C=-log(arg)/log(.99), B=-1/log(.99) = 229.15",
  "         BINE   SHIFTDIV ; C-B: branch if not less than",
  "         SCBC   MANT ; C -= B",
  "         AAKA   MANT1 ; A++",
  "         BIE    LOGDIV ; BET",
  "SHIFTDIV AAKC   DIGIT1 ; shift remainder C left, increase mantissa",
  "         BINE   LABEL291 ; so C > B",
  "         SLLA   MANT",
  "         ACKA   DIGIT",
  "         SLLC   MANT",
  "         BIE    LOGDIV ; until count hits 10",
  "LABEL291 AKA    DIGIT",
  "         TFA    UP_LOW ; pick the return target",
  "         BINE   LOGSKIP",
  "         BIE    WRAPUP",
  "WAITED   BIE    WAITED2 ; inconvenient WAITNO target",
  "LOGSKIP  AAKC   MANT ; A mantissa -> C",
  "         AKA    MANT ; clear A mantissa",
  "         SRLA   ALL ; shift exponent into top of mantissa (log of exponent)",
  "         SRLA   ALL",
  "         AKA    EXP ; clear exponent",
  "         BIE    ADDSUB ; BET (clear from AAKC)",
  "ANTILOG  AAKC   MANT",
  "         AKA    MANT",
  "         AKA    MASK11",
  "         SABA   MANT",
  "         EXAB   MANT",
  "         BIE    LABEL117 ; Sub call to multiply by 229.15",
  "LABEL308 SRLA   MANT",
  "         SFB    NEWEXP",
  "         BIE    LOG ; ? What is condition here?",
  "ALOGLOOP SAKA   MANTD1",
  "         BIE    LOGLOOP",
  "         AAKA   MANTD1",
  "         SLLA   MANT",
  "         AAKA   MASK11",
  "         ABCC   MANT",
  "         EXAB   MANT",
  "         ZFA    UP_LOW",
  "         BINE   LABEL278 ; isn't flag zero after ZFA?? Maybe still NE from ABCC?",
];
var objectCode = [
1408,1392,1792,1824,1860,1808,1360,1376,
518,1319,1360,1376,9,1360,1908,1072,
1083,1075,1121,1129,1073,1069,1051,1840,
1955,1840,516,1425,552,1430,33,1792,
1398,1631,1920,1683,34,2003,1540,4,
1399,1858,1872,1538,4,1329,1335,4,
1349,1347,4,1443,676,1431,57,1559,
4,1553,59,1443,677,1839,1632,2018,
65,2023,1719,72,1730,71,1840,1666,
1751,587,1840,1754,78,1840,1718,594,
1924,78,2017,1713,89,1540,130,1844,
1841,1652,597,130,1730,95,1849,1650,
114,1443,675,1355,1345,130,1409,1559,
105,1443,750,1839,1632,1844,2023,1719,
92,1538,1537,116,1451,1796,791,1908,
1781,637,1722,1540,120,1940,1786,119,
1445,820,1754,512,1747,145,1860,1751,
142,1686,141,1799,1798,1686,1558,132,
132,1908,1751,662,1686,1686,1558,152,
1441,614,1392,1334,1408,1750,161,1559,
159,1568,4,1351,1355,1686,681,1908,
165,1801,1689,1824,1445,180,1447,179,
1568,1819,185,1565,1820,1924,2011,1693,
738,1888,1888,1888,2012,1696,1936,1936,
1936,1872,1872,1872,2012,1584,1724,1920,
1920,1920,1445,183,1561,1447,210,1779,
697,220,1451,727,1732,185,220,1754,
1844,1764,1844,185,1904,1904,1904,1904,
1904,130,1447,233,1616,1600,1808,1411,
100,1451,236,1632,1840,130,1445,251,
1750,760,1751,759,1908,1686,240,1860,
1794,1864,1864,1824,2003,1636,1924,1924,
1700,1431,823,2009,1787,253,1993,2036,
1723,1920,1920,1920,1920,1588,1844,1445,
814,1600,1479,1447,765,1572,1796,1806,
1764,797,1700,1562,280,1571,803,1860,
1631,1892,280,1807,1443,808,130,10,
1572,1796,1904,1904,1794,61,1572,1796,
1803,1652,1844,117,1908,1335,251,1693,
253,1565,1860,1563,2036,1844,1411,790,
];
